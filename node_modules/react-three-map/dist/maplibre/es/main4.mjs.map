{"version":3,"file":"main4.mjs","sources":["../../../src/api/coordinates.tsx"],"sourcesContent":["import { createPortal, useFrame, useThree } from \"@react-three/fiber\";\nimport { PropsWithChildren, memo, useLayoutEffect, useRef, useState } from \"react\";\nimport { Matrix4Tuple, PerspectiveCamera, Scene } from \"three\";\nimport { syncCamera } from \"../core/sync-camera\";\nimport { useCoordsToMatrix } from \"../core/use-coords-to-matrix\";\nimport { R3M, useR3M } from \"../core/use-r3m\";\n\nexport interface CoordinatesProps extends PropsWithChildren {\n  longitude: number,\n  latitude: number,\n  altitude?: number,\n}\n\nexport const Coordinates = memo<CoordinatesProps>(({\n  latitude, longitude, altitude = 0, children\n}) => {\n\n  const [scene] = useState(() => new Scene())\n\n  const r3m = useR3M();\n\n  const origin = useCoordsToMatrix({\n    latitude, longitude, altitude, fromLngLat: r3m.fromLngLat,\n  });\n\n\n  return <>{createPortal(<>\n    <RenderAtCoords r3m={r3m} origin={origin} />\n    {children}\n  </>, scene, { events: { priority: 2 } })}</>\n})\n\nCoordinates.displayName = 'Coordinates';\n\ninterface RenderAtCoordsProps {\n  r3m: R3M,\n  origin: Matrix4Tuple\n}\n\nfunction RenderAtCoords({ r3m, origin }: RenderAtCoordsProps) {\n\n  const { gl, scene, set } = useThree()\n\n  const cameraRef = useRef<PerspectiveCamera>(null)\n\n  useFrame(() => {\n    if (!cameraRef.current) return;\n    syncCamera(cameraRef.current, origin, r3m.viewProjMx);\n    gl.render(scene, cameraRef.current);\n  })\n\n  useLayoutEffect(() => {\n    if (!cameraRef.current) return;\n    set({\n      invalidate: () => {\n        if (!r3m.map) return;\n        r3m.map.triggerRepaint();\n      },\n      camera: cameraRef.current,\n    });\n  }, [set, r3m])\n\n  return <perspectiveCamera ref={cameraRef} />\n}"],"names":[],"mappings":";;;;;;;AAaa,MAAA,cAAc,KAAuB,CAAC;AAAA,EACjD;AAAA,EAAU;AAAA,EAAW,WAAW;AAAA,EAAG;AACrC,MAAM;AAEJ,QAAM,CAAC,KAAK,IAAI,SAAS,MAAM,IAAI,MAAO,CAAA;AAE1C,QAAM,MAAM;AAEZ,QAAM,SAAS,kBAAkB;AAAA,IAC/B;AAAA,IAAU;AAAA,IAAW;AAAA,IAAU,YAAY,IAAI;AAAA,EAAA,CAChD;AAGM,SAAA,oBAAA,UAAA,EAAG,uBACR,qBAAA,UAAA,EAAA,UAAA;AAAA,IAAC,oBAAA,gBAAA,EAAe,KAAU,OAAgB,CAAA;AAAA,IACzC;AAAA,EAAA,GACH,GAAK,OAAO,EAAE,QAAQ,EAAE,UAAU,EAAA,GAAK,EAAE,CAAA;AAC3C,CAAC;AAED,YAAY,cAAc;AAO1B,SAAS,eAAe,EAAE,KAAK,UAA+B;AAE5D,QAAM,EAAE,IAAI,OAAO,QAAQ,SAAS;AAE9B,QAAA,YAAY,OAA0B,IAAI;AAEhD,WAAS,MAAM;AACb,QAAI,CAAC,UAAU;AAAS;AACxB,eAAW,UAAU,SAAS,QAAQ,IAAI,UAAU;AACjD,OAAA,OAAO,OAAO,UAAU,OAAO;AAAA,EAAA,CACnC;AAED,kBAAgB,MAAM;AACpB,QAAI,CAAC,UAAU;AAAS;AACpB,QAAA;AAAA,MACF,YAAY,MAAM;AAChB,YAAI,CAAC,IAAI;AAAK;AACd,YAAI,IAAI;MACV;AAAA,MACA,QAAQ,UAAU;AAAA,IAAA,CACnB;AAAA,EAAA,GACA,CAAC,KAAK,GAAG,CAAC;AAEN,SAAA,oBAAC,qBAAkB,EAAA,KAAK,UAAW,CAAA;AAC5C;"}