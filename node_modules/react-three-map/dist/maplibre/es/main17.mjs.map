{"version":3,"file":"main17.mjs","sources":["../../../src/core/canvas-in-layer/use-root.tsx"],"sourcesContent":["import { _roots, createRoot } from \"@react-three/fiber\";\nimport { useEffect, useState } from \"react\";\nimport { CanvasProps } from \"../../api/canvas-props\";\nimport { events } from \"../events\";\nimport { FromLngLat, MapInstance } from \"../generic-map\";\nimport { setCoords, useSetRootCoords } from \"../use-coords\";\nimport { useFunction } from \"../use-function\";\nimport { initR3M } from \"../use-r3m\";\n\nexport function useRoot(\n  fromLngLat: FromLngLat,\n  map: MapInstance,\n  { frameloop, longitude, latitude, altitude, ...props }: CanvasProps\n) {\n\n  const [{ root, useThree, canvas, r3m }] = useState(() => {\n    const canvas = map.getCanvas();\n    const gl = (canvas.getContext('webgl2') || canvas.getContext('webgl')) as WebGLRenderingContext;\n\n    const root = createRoot(canvas);\n    root.configure({\n      dpr: window.devicePixelRatio,\n      events,\n      ...props,\n      frameloop: 'never',\n      gl: {\n        context: gl,\n        autoClear: false,\n        antialias: true,\n        ...props?.gl,\n      },\n      onCreated: (state) => {\n        state.gl.forceContextLoss = () => { }; // eslint-disable-line @typescript-eslint/no-empty-function\n      },\n      camera: {\n        matrixAutoUpdate: false,\n        near: 0,\n      },\n      size: {\n        width: canvas.clientWidth,\n        height: canvas.clientHeight,\n        top: canvas.offsetTop,\n        left: canvas.offsetLeft,\n        updateStyle: false,\n        ...props?.size,\n      },\n    });\n\n    const store = _roots.get(canvas)!.store; // eslint-disable-line @typescript-eslint/no-non-null-assertion\n\n    const r3m = initR3M({ map, fromLngLat, store });\n    setCoords(store, {longitude, latitude, altitude});\n\n    if (frameloop === 'demand') {\n      store.setState({\n        frameloop,\n        invalidate: () => {\n          map.triggerRepaint();\n        },\n      })\n    }\n\n    return { root, useThree: store, map, canvas, r3m }\n\n  })\n\n  const onResize = useFunction(() => {\n\n    const { setDpr, setSize } = useThree.getState();\n\n    setDpr(window.devicePixelRatio);\n\n    setSize(\n      canvas.clientWidth,\n      canvas.clientHeight,\n      false,\n      canvas.offsetTop,\n      canvas.offsetLeft,\n    );\n\n  })\n\n  const onRemove = useFunction(() => {\n    root.unmount();\n  })\n\n  useSetRootCoords(useThree, {longitude, latitude, altitude});\n\n  // on `frameloop` change\n  useEffect(() => {\n    if (frameloop !== 'demand') return;\n    const setState = useThree.setState;\n    const { invalidate } = useThree.getState();\n    setState({\n      frameloop,\n      invalidate: () => {\n        map.triggerRepaint();\n      }\n    });\n    return () => {\n      setState({ frameloop: 'never', invalidate })\n    }\n  }, [frameloop]) // eslint-disable-line react-hooks/exhaustive-deps\n\n  // on mount / unmount\n  useEffect(() => {\n    map.on('resize', onResize);\n    return () => {\n      map.off('resize', onResize)\n    }\n  }, []) // eslint-disable-line react-hooks/exhaustive-deps\n\n  // root.render\n  useEffect(() => {\n    root.render(<>\n      {props.children}\n    </>);\n  }, [props.children]) // eslint-disable-line react-hooks/exhaustive-deps\n\n  return { onRemove, useThree, r3m };\n}"],"names":["canvas","root","r3m"],"mappings":";;;;;;;AASgB,SAAA,QACd,YACA,KACA,EAAE,WAAW,WAAW,UAAU,UAAU,GAAG,SAC/C;AAEM,QAAA,CAAC,EAAE,MAAM,UAAU,QAAQ,IAAK,CAAA,IAAI,SAAS,MAAM;AACjDA,UAAAA,UAAS,IAAI;AACnB,UAAM,KAAMA,QAAO,WAAW,QAAQ,KAAKA,QAAO,WAAW,OAAO;AAE9DC,UAAAA,QAAO,WAAWD,OAAM;AAC9BC,UAAK,UAAU;AAAA,MACb,KAAK,OAAO;AAAA,MACZ;AAAA,MACA,GAAG;AAAA,MACH,WAAW;AAAA,MACX,IAAI;AAAA,QACF,SAAS;AAAA,QACT,WAAW;AAAA,QACX,WAAW;AAAA,QACX,GAAG,+BAAO;AAAA,MACZ;AAAA,MACA,WAAW,CAAC,UAAU;AACd,cAAA,GAAG,mBAAmB,MAAM;AAAA,QAAA;AAAA,MACpC;AAAA,MACA,QAAQ;AAAA,QACN,kBAAkB;AAAA,QAClB,MAAM;AAAA,MACR;AAAA,MACA,MAAM;AAAA,QACJ,OAAOD,QAAO;AAAA,QACd,QAAQA,QAAO;AAAA,QACf,KAAKA,QAAO;AAAA,QACZ,MAAMA,QAAO;AAAA,QACb,aAAa;AAAA,QACb,GAAG,+BAAO;AAAA,MACZ;AAAA,IAAA,CACD;AAED,UAAM,QAAQ,OAAO,IAAIA,OAAM,EAAG;AAElC,UAAME,OAAM,QAAQ,EAAE,KAAK,YAAY,OAAO;AAC9C,cAAU,OAAO,EAAC,WAAW,UAAU,SAAS,CAAA;AAEhD,QAAI,cAAc,UAAU;AAC1B,YAAM,SAAS;AAAA,QACb;AAAA,QACA,YAAY,MAAM;AAChB,cAAI,eAAe;AAAA,QACrB;AAAA,MAAA,CACD;AAAA,IACH;AAEO,WAAA,EAAE,MAAAD,OAAM,UAAU,OAAO,KAAK,QAAAD,SAAQ,KAAAE;EAAI,CAElD;AAEK,QAAA,WAAW,YAAY,MAAM;AAEjC,UAAM,EAAE,QAAQ,QAAQ,IAAI,SAAS,SAAS;AAE9C,WAAO,OAAO,gBAAgB;AAE9B;AAAA,MACE,OAAO;AAAA,MACP,OAAO;AAAA,MACP;AAAA,MACA,OAAO;AAAA,MACP,OAAO;AAAA,IAAA;AAAA,EACT,CAED;AAEK,QAAA,WAAW,YAAY,MAAM;AACjC,SAAK,QAAQ;AAAA,EAAA,CACd;AAED,mBAAiB,UAAU,EAAC,WAAW,UAAU,SAAS,CAAA;AAG1D,YAAU,MAAM;AACd,QAAI,cAAc;AAAU;AAC5B,UAAM,WAAW,SAAS;AAC1B,UAAM,EAAE,WAAA,IAAe,SAAS,SAAS;AAChC,aAAA;AAAA,MACP;AAAA,MACA,YAAY,MAAM;AAChB,YAAI,eAAe;AAAA,MACrB;AAAA,IAAA,CACD;AACD,WAAO,MAAM;AACX,eAAS,EAAE,WAAW,SAAS,WAAY,CAAA;AAAA,IAAA;AAAA,EAC7C,GACC,CAAC,SAAS,CAAC;AAGd,YAAU,MAAM;AACV,QAAA,GAAG,UAAU,QAAQ;AACzB,WAAO,MAAM;AACP,UAAA,IAAI,UAAU,QAAQ;AAAA,IAAA;AAAA,EAE9B,GAAG,CAAE,CAAA;AAGL,YAAU,MAAM;AACd,SAAK,OAAO,oBAAA,UAAA,EACT,UAAM,MAAA,SACT,CAAA,CAAG;AAAA,EAAA,GACF,CAAC,MAAM,QAAQ,CAAC;AAEZ,SAAA,EAAE,UAAU,UAAU;AAC/B;"}