(()=>{var j=Object.create;var L=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var N=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var V=(a,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of F(t))!G.call(a,r)&&r!==e&&L(a,r,{get:()=>t[r],enumerable:!(s=z(t,r))||s.enumerable});return a};var M=(a,t,e)=>(e=a!=null?j(H(a)):{},V(t||!a||!a.__esModule?L(e,"default",{value:a,enumerable:!0}):e,a));var d=N((J,P)=>{P.exports=THREE});var h=M(d(),1);var o=63710088e-1,R=2*Math.PI*o,i=Math.PI/180,Y=180/Math.PI,m=1024e3/R,T=512;var E=class{static clamp(t,e,s){return Math.min(s,Math.max(e,t))}static makePerspectiveMatrix(t,e,s,r){let _=1/Math.tan(t/2),l=1/(s-r);return[_/e,0,0,0,0,_,0,0,0,0,(r+s)*l,-1,0,0,2*r*s*l,0]}static mercatorXFromLng(t){return(180+t)/360}static mercatorYFromLat(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}},p=E;var n=M(d(),1),v=new n.Matrix4,C=new n.Matrix4,A=85.051129,x=class{constructor(t){this._map=t.map,this._world=t.world,this._camera=t.camera,this._translateCenter=new n.Matrix4().makeTranslation(1024e3/2,-1024e3/2,0),this._worldSizeRatio=T/1024e3,this._map.on("move",this.syncCamera.bind(this)),this._map.on("resize",this.syncCamera.bind(this))}syncCamera(){let t=this._map.transform;this._camera.aspect=t.width/t.height;let e=t.centerOffset||new n.Vector3,s=t.fov*i,r=t.pitch*i,_=t.bearing*i;v.elements=p.makePerspectiveMatrix(s,this._camera.aspect,t.height/50,t.farZ),this._camera.projectionMatrix=v,this._camera.projectionMatrix.elements[8]=-e.x*2/t.width,this._camera.projectionMatrix.elements[9]=e.y*2/t.height,C.makeTranslation(0,0,t.cameraToCenterDistance);let l=new n.Matrix4().premultiply(C).premultiply(new n.Matrix4().makeRotationX(r)).premultiply(new n.Matrix4().makeRotationZ(-_));t.elevation&&(l.elements[14]=t.cameraToCenterDistance*Math.cos(r)),this._camera.matrixWorld.copy(l);let f=t.scale*this._worldSizeRatio,U=new n.Matrix4().makeScale(f,f,f),u=t.x,w=t.y;if(!u||!w){let D=t.center,b=p.clamp(D.lat,-A,A);u=p.mercatorXFromLng(D.lng)*t.worldSize,w=p.mercatorYFromLat(b)*t.worldSize}let W=new n.Matrix4().makeTranslation(-u,w,0),k=new n.Matrix4().makeRotationZ(Math.PI);this._world.matrix=new n.Matrix4().premultiply(k).premultiply(this._translateCenter).premultiply(U).premultiply(W)}},O=x;var X={scene:null,camera:null,renderer:null,preserveDrawingBuffer:!1,renderLoop:a=>{a.renderer.resetState(),a.renderer.render(a.scene,a.camera)}},I=class{constructor(t,e={}){if(!t)throw"miss map";this._map=t,this._options={...X,...e},this._canvas=t.getCanvas(),this._scene=this._options.scene||new h.Scene,this._camera=this._options.camera||new h.PerspectiveCamera(this._map.transform.fov,this._map.transform.width/this._map.transform.height,.1,1e21),this._camera.matrixAutoUpdate=!1,this._renderer=this._options.renderer||new h.WebGLRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:this._options.preserveDrawingBuffer,canvas:this._canvas,context:this._canvas.getContext("webgl2")}),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(this._canvas.clientWidth,this._canvas.clientHeight),this._renderer.autoClear=!1,this._world=new h.Group,this._world.name="world",this._world.position.set(1024e3/2,1024e3/2,0),this._world.matrixAutoUpdate=!1,this._scene.add(this._world),this._cameraSync=void 0,this._map.on("style.load",this._onStyleLoad.bind(this))}get map(){return this._map}get canvas(){return this._canvas}get camera(){return this._camera}get scene(){return this._scene}get world(){return this._world}get renderer(){return this._renderer}_onStyleLoad(){let t=this;this._map.addLayer({id:"map_scene_layer",type:"custom",renderingMode:"3d",onAdd:function(e,s){t._cameraSync||(this._cameraSync=new O(t),this._cameraSync.syncCamera())},render:function(e,s){t.render()}})}render(){return this._options.renderLoop(this),this}},y=I;var Z=M(d(),1);var S=class{static projectedUnitsPerMeter(t){return Math.abs(1024e3/Math.cos(i*t)/R)}static lngLatToVector3(t,e,s=0){let r=[0,0,0];return Array.isArray(t)?(r=[-o*i*t[0]*m,-o*Math.log(Math.tan(Math.PI*.25+.5*i*t[1]))*m],t[2]?r.push(t[2]*this.projectedUnitsPerMeter(t[1])):r.push(0)):(r=[-o*i*t*m,-o*Math.log(Math.tan(Math.PI*.25+.5*i*e))*m],s?r.push(s*this.projectedUnitsPerMeter(e)):r.push(0)),new Z.Vector3(r[0],r[1],r[2])}static vector3ToLngLat(t){let e={lng:0,lat:0,alt:0};return t&&(e.lng=-t.x/(o*i*m),e.lat=2*(Math.atan(Math.exp(t.y/(m*-o)))-Math.PI/4)/i,e.alt=t.z/this.projectedUnitsPerMeter(e.lat)),e}},g=S;window.THREE&&(window.MapScene=y,window.SceneTransform=g);})();
