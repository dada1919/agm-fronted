
## 概述

本文档定义了机场管理系统(AGM-Simulator)的Socket.IO实时通信接口规范，包括连接配置、事件定义、数据结构和使用示例。

## 服务器配置

### 连接信息
- **协议**: WebSocket over HTTP/HTTPS
- **默认URL**: `http://localhost:5000`
- **传输方式**: Socket.IO v4.x
- **命名空间**: 默认命名空间 `/`
### CORS配置

允许的来源域名：
- `http://localhost:5173` (Vite开发服务器)
- `http://localhost:5174` (Vite备用端口)
- `http://localhost:5000` (同源访问)

## 连接管理
### 建立连接

```javascript
const socket = io('http://localhost:5000', {

  transports: ['websocket', 'polling'],

  timeout: 20000,

  reconnection: true,

  reconnectionAttempts: 5,

  reconnectionDelay: 1000

});

```


### 连接事件

#### `connect`

**类型**: 系统事件  
**方向**: 服务器 → 客户端  
**描述**: 连接建立成功  
**数据**: 无

```javascript

socket.on('connect', () => {

  console.log('已连接到服务器');

  console.log('连接ID:', socket.id);

});

```


#### `disconnect`

**类型**: 系统事件  
**方向**: 服务器 → 客户端  
**描述**: 连接断开  
**数据**: 断开原因字符串

```javascript

socket.on('disconnect', (reason) => {

  console.log('连接断开:', reason);

});

```

## 业务事件接口

### 1. 系统控制
#### `simulate_start`

**类型**: 客户端事件  
**方向**: 客户端 → 服务器  
**描述**: 启动机场系统模拟  
**参数**: 无  
**响应**: `simulation_status`

```javascript

socket.emit('simulate_start');

```

#### `simulate_stop`

**类型**: 客户端事件  
**方向**: 客户端 → 服务器  
**描述**: 停止机场系统模拟  
**参数**: 无  
**响应**: `simulation_status`

```javascript

socket.emit('simulate_stop');

```

#### `simulation_status`

**类型**: 服务器事件  
**方向**: 服务器 → 客户端  
**描述**: 模拟状态变更通知
**数据结构**:
```typescript

interface SimulationStatus {

  status: 'started' | 'stopped' | 'error';

  message: string;

  timestamp?: string;

}

```

  

**示例**:

```javascript

socket.on('simulation_status', (data) => {

  console.log(`模拟状态: ${data.status} - ${data.message}`);

});

```

  

### 2. 系统状态查询

#### `get_system_state`

**类型**: 客户端事件  

**方向**: 客户端 → 服务器  

**描述**: 获取当前系统状态  

**参数**: 无  

**响应**: `system_state_update`

```javascript

socket.emit('get_system_state');

```

#### `system_state_update`

**类型**: 服务器事件  

**方向**: 服务器 → 客户端  

**描述**: 系统状态数据推送

**数据结构**:

```typescript

interface SystemState {

  timestamp: string;

  aircraft_positions: {

    [flight_id: string]: {

      position: string;

      status: 'taxiing' | 'waiting' | 'takeoff' | 'completed';

      progress: number; // 0-1

      remaining_taxi_time?: number; // 秒

      time_to_takeoff?: number; // 秒

    }

  };

  active_flights: string[];

  planned_flights: {

    [flight_id: string]: {

      start_time: string;

      path: string[];

      status: string;

    }

  };

  last_update: number;

}

```

### 3. 航班管理

#### `adjust_flight_time`

**类型**: 客户端事件  

**方向**: 客户端 → 服务器  

**描述**: 调整航班滑行时间  

**响应**: `flight_adjustment_result`

**参数结构**:

```typescript

interface AdjustFlightRequest {

  flight_id: string;

  adjust_time: int; // 相对时间（单位：秒），负数表示向前调整，正数向后调整

}

```


**示例**:

```javascript

socket.emit('adjust_flight_time', {

  flight_id: 'CA1234',

  adjust_time: '60'

});

```

  

#### `flight_adjustment_result`

**类型**: 服务器事件  

**方向**: 服务器 → 客户端  

**描述**: 航班调整结果反馈

**数据结构**:

```typescript

interface FlightAdjustmentResult {

  flight_id: string;

  success: boolean;

  message: string;

  adjust_time?: string;

  error_code?: string;

}

```

  **示例**:
  
  ```python
  #调整成功
  {

                'flight_id': flight_id,

                'success': True,

                'message': '调整请求已提交',

                'adjust_time': adjust_time

  }
            
  #调整失败
  {

                    'flight_id': flight_id,

                    'success': False,

                    'message': f'航班 {flight_id} 不在当前规划中'

  }
  ```


### 4. 实时数据推送

#### `aircraft_status_update`

**类型**: 服务器事件  

**方向**: 服务器 → 客户端  

**描述**: 飞机状态实时更新  

**频率**: 约每秒1次

**数据结构**:

```typescript

interface AircraftStatusUpdate {

  timestamp: string;

  aircraft_positions: {

    [flight_id: string]: {

      position: string;

      status: string;

      progress: number;

      remaining_taxi_time: number;

      time_to_takeoff: number;

    }

  };

}

```

示例：

```json
[ "aircraft_status_update", { "active_aircraft": { "CCA1642": { "coords": [ 116.58947615830589, 40.071327195493446 ], "speed": 8.33, "state": "normal", "path_progress": "21/22", "position": 18.05108031519741, "remaining_taxi_time": 3.807982103858414, "time_to_takeoff": 0, "departure_time": "2023-11-02T00:00:08.479372", "trajectory": [ [ [ [ 116.58947615830589, 40.071327195493446 ], [ 116.58952079475993, 40.071043978654586 ] ] ] ] } }, "planned_aircraft": { "CHH7538": { "flight_id": "CHH7538", "status": "planned", "time_to_start": 88, "time_to_takeoff": 665, "taxi_time": 576, "origin": "294", "destination": "1968", "start_time": 88, "node_times": {} }, "ETH605": { "flight_id": "ETH605", "status": "planned", "time_to_start": 90, "time_to_takeoff": 1270, "taxi_time": 1179, "origin": "1996", "destination": "41", "start_time": 90, "node_times": {} }, "CHH7716": { "flight_id": "CHH7716", "status": "planned", "time_to_start": 230, "time_to_takeoff": 1156, "taxi_time": 925, "origin": "745", "destination": "1920", "start_time": 230, "node_times": {} }, "CHH7184": { "flight_id": "CHH7184", "status": "planned", "time_to_start": 549, "time_to_takeoff": 1743, "taxi_time": 1193, "origin": "397", "destination": "1329", "start_time": 549, "node_times": {} } } } ]
```
#### `planning_update`

**类型**: 服务器事件  

**方向**: 服务器 → 客户端  

**描述**: 规划结果更新  

**频率**: 规划变更时触发

**数据结构**:

```typescript

interface PlanningUpdate {

  timestamp: string;

  planned_flights: {

    [flight_id: string]: {

      start_time: string;

      path: string[];

      status: string;

    }

  };

}

```

  示例
```json
["planning_update",{"planned_flights":{"CCA1642":{"path":[["841",1],["840",1],["839",1],["838",1],["837",1],["836",1],["835",1],["834",1],["833",1],["2822",1],["736",0],["737",0],["2851",1],["2855",1],["2840",1],["2839",1],["2838",0],["2830",0],["2831",0],["2832",0],["2833",0],["2834",0]],"node_path":["775","774","773","772","771","770","769","768","767","766","671","672","673","1826","1821","1820","1819","1813","1814","1815","1816","1817","1818"],"taxiway_sequence":["841","840","839","838","837","836","835","834","833","2822","736","737","2851","2855","2840","2839","2838","2830","2831","2832","2833","2834"],"taxi_time":449.3087355738903,"start_time":"2023-11-02T00:00:06","origin":"775","destination":"1818"},"CHH7538":{"path":[["344",0],["345",0],["346",0],["347",0],["348",0],["349",0],["350",0],["351",0],["352",0],["2126",1],["2124",1],["2123",1],["2122",1],["2130",0],["2132",0]],"node_path":["294","295","296","297","298","299","300","301","302","303","1552","1551","1550","1549","1554","1968"],"taxiway_sequence":["344","345","346","347","348","349","350","351","352","2126","2124","2123","2122","2130","2132"],"taxi_time":576.7686521583825,"start_time":"2023-11-02T00:01:56","origin":"294","destination":"1968"},"ETH605":{"path":[["1389",1],["1388",1],["160",1],["159",1],["158",1],["157",1],["156",1],["155",1],["154",1],["153",1],["152",1],["151",1],["150",1],["149",1],["148",1],["147",1],["146",1],["2639",1],["893",1],["2627",0],["818",1],["817",1],["816",1],["2724",1],["658",1],["2720",0],["186",1],["185",1],["184",1],["183",1],["182",1],["181",1],["2716",1],["64",1]],"node_path":["1996","1149","131","130","129","128","127","126","125","124","123","122","121","120","119","118","117","116","824","823","1745","751","750","749","598","597","152","151","150","149","148","147","146","42","41"],"taxiway_sequence":["1389","1388","160","159","158","157","156","155","154","153","152","151","150","149","148","147","146","2639","893","2627","818","817","816","2724","658","2720","186","185","184","183","182","181","2716","64"],"taxi_time":1179.5237413367543,"start_time":"2023-11-02T00:01:58","origin":"1996","destination":"41"},"CHH7716":{"path":[["1618",0],["797",1],["796",1],["795",1],["794",1],["793",1],["792",1],["937",1],["791",1],["790",1],["789",1],["788",1],["787",1],["786",1],["1771",0],["880",0],["881",0],["882",0],["1932",0],["1934",0],["1936",0],["1785",0],["1786",0],["1787",0]],"node_path":["745","731","730","729","728","727","726","725","863","724","723","722","721","720","719","811","812","813","814","1456","1457","1391","1392","1393","1920"],"taxiway_sequence":["1618","797","796","795","794","793","792","937","791","790","789","788","787","786","1771","880","881","882","1932","1934","1936","1785","1786","1787"],"taxi_time":925.6569040229369,"start_time":"2023-11-02T00:04:18","origin":"745","destination":"1920"},"CHH7184":{"path":[["1563",1],["2895",1],["2894",0],["345",0],["346",0],["347",0],["348",0],["349",0],["350",0],["351",0],["352",0],["2126",1],["2124",1],["2127",1],["841",0],["842",0],["843",0],["844",0],["847",0],["848",0],["849",0],["850",0],["851",0],["852",0],["2098",0],["1459",1],["1458",1],["1457",1],["1456",1],["1455",1],["1454",1],["1453",1],["1452",1],["1451",1],["1654",1]],"node_path":["397","1278","1845","295","296","297","298","299","300","301","302","303","1552","1551","774","775","776","777","778","779","780","781","782","783","784","1203","1202","1201","1200","1199","1198","1197","1196","1195","1194","1329"],"taxiway_sequence":["1563","2895","2894","345","346","347","348","349","350","351","352","2126","2124","2127","841","842","843","844","847","848","849","850","851","852","2098","1459","1458","1457","1456","1455","1454","1453","1452","1451","1654"],"taxi_time":1193.6505629027668,"start_time":"2023-11-02T00:09:37","origin":"397","destination":"1329"}},"active_flights":{},"conflicts":[]}]
```

### 5. 冲突检测与解决

#### `conflicts_update`

**类型**: 服务器事件  

**方向**: 服务器 → 客户端  

**描述**: 冲突信息更新

**数据结构**:

```typescript

interface ConflictsUpdate {

  timestamp: string;

  conflicts: {

    current: Array<[string, string[], number]>; // [节点名称, [航班ID1, 航班ID2], 相对时间(分钟)(距离发生冲突的相对时间)]

    future: Array<[string, string[], number]>;  // [节点名称, [航班ID1, 航班ID2], 相对时间(分钟)]

  };

}

```

示例
```json
{
  "timestamp": "2023-11-02T10:30:15.123Z",
  "conflicts": {
    "current": [
      ["T1", ["CZ3101", "MU5735"], 0.5],
      ["R1", ["CA1234", "HU7890"], 1.2]
    ],
    "future": [
      ["T3", ["3U8888", "9C8765"], 5.8],
      ["T2", ["FM9876", "GJ1111"], 8.3],
      ["R2", ["CZ5432", "MU1098"], 12.7]
    ]
  }
}
```
## 错误处理

### 错误响应格式

所有错误响应都遵循统一格式：


```typescript

interface ErrorResponse {

  success: false;

  error_code: string;

  message: string;

  details?: any;

  timestamp: string;

}

```

  

### 常见错误码

  

| 错误码 | 描述 | 处理建议 |

|--------|------|----------|

| `SYSTEM_NOT_INITIALIZED` | 机场系统未初始化 | 等待系统启动完成 |

| `INVALID_FLIGHT_ID` | 无效的航班ID | 检查航班ID格式 |

| `INVALID_TIME_FORMAT` | 时间格式错误 | 使用ISO 8601格式 |

| `CONFLICT_NOT_FOUND` | 冲突不存在 | 刷新冲突列表 |

| `RESOLUTION_FAILED` | 解决方案应用失败 | 重试或选择其他方案 |

| `PERMISSION_DENIED` | 权限不足 | 检查用户权限 |

| `RATE_LIMIT_EXCEEDED` | 请求频率过高 | 降低请求频率 |

  

### 错误处理示例

  

```javascript

socket.on('flight_adjustment_result', (result) => {

  if (!result.success) {

    switch (result.error_code) {

      case 'INVALID_FLIGHT_ID':

        showError('航班ID无效，请检查输入');

        break;

      case 'INVALID_TIME_FORMAT':

        showError('时间格式错误，请使用正确格式');

        break;

      default:

        showError(`操作失败: ${result.message}`);

    }

  } else {

    showSuccess('航班时间调整成功');

  }

});

```

  

## 客户端实现示例

### 基础连接管理

```javascript

class AGMSocketClient {

  constructor(serverUrl = 'http://localhost:5000') {

    this.socket = io(serverUrl, {

      transports: ['websocket', 'polling'],

      timeout: 20000,

      reconnection: true,

      reconnectionAttempts: 5,

      reconnectionDelay: 1000

    });

    this.initializeEventListeners();

  }

  initializeEventListeners() {

    // 连接管理

    this.socket.on('connect', () => {

      console.log('已连接到AGM服务器');

      this.onConnected();

    });

    this.socket.on('disconnect', (reason) => {

      console.log('连接断开:', reason);

      this.onDisconnected(reason);

    });

    this.socket.on('connect_error', (error) => {

      console.error('连接错误:', error);

      this.onConnectionError(error);

    });

    // 业务事件

    this.socket.on('aircraft_status_update', (data) => {

      this.handleAircraftStatusUpdate(data);

    });

    this.socket.on('conflicts_update', (data) => {

      this.handleConflictsUpdate(data);

    });

    this.socket.on('conflict_resolutions_update', (data) => {

      this.handleConflictResolutionsUpdate(data);

    });

  }

  // 系统控制方法

  startSimulation() {

    this.socket.emit('simulate_start');

  }

  stopSimulation() {

    this.socket.emit('simulate_stop');

  }

  getSystemState() {

    this.socket.emit('get_system_state');

  }

  // 航班管理方法

  adjustFlightTime(flightId, adjustTime) {

    this.socket.emit('adjust_flight_time', {

      flight_id: flightId,

      adjust_time: adjustTime

    });

  }

  // 冲突解决方法

  getConflictResolutions(conflictId) {

    this.socket.emit('get_conflict_resolutions', {

      conflict_id: conflictId

    });

  }

  applyConflictResolution(conflictId, solutionId) {

    this.socket.emit('apply_conflict_resolution', {

      conflict_id: conflictId,

      solution_id: solutionId

    });

  }

  // 事件处理方法(需要子类实现)

  onConnected() { /* 实现连接成功逻辑 */ }

  onDisconnected(reason) { /* 实现断开连接逻辑 */ }

  onConnectionError(error) { /* 实现连接错误逻辑 */ }

  handleSystemStateUpdate(data) { /* 实现系统状态更新逻辑 */ }

  handleAircraftStatusUpdate(data) { /* 实现飞机状态更新逻辑 */ }

  handleConflictsUpdate(data) { /* 实现冲突更新逻辑 */ }

  handleConflictResolutionsUpdate(data) { /* 实现解决方案更新逻辑 */ }

}

```

